#include<stdio.h>
#include<stdint.h>
#include "intel.c"

#include "cpucycles.c"



uint32_t scaling_constants[] = {1044211860,832312758,504512149,291046984,542991440,128249837,951257524,1007922024,496021122,361631712,128502634,818054863,369173229};

uint32_t crt_constant[13][12]={
{4226940929,3935095565,3315952819,3045703539,3585431252,1231857571,3050172953,2774123176,2354534217,2185658641,986407444,240},
{4226285569,801468647,4083728898,233539407,2297405399,2567113475,3082481291,3537890912,507747331,3241232680,353996437,240},
{4224778241,940018413,2890099876,95892872,54852281,2737201690,3400346585,3928376520,1381516014,155894544,3197356354,239},
{4223991809,698006409,1268782511,1368466027,3123727835,1648603478,1717277730,3472349122,3926214714,3191327380,2441617242,239},
{4223008769,219199969,1165887434,4187144956,559781460,3275103936,1759930574,428888967,2535494165,2835618517,1498501935,239},
{4222025729,2839460347,3698734208,1615790412,666993176,3706144995,4003271902,2894961117,1322192127,4243554284,557113945,239},
{4227072001,588137363,2745025699,1958441046,1330762856,1271705133,718422962,3910279228,4260755437,1958470855,1112982744,240},
{4227268609,1151957099,3679676293,1760311824,745742382,3793016862,1645505609,2650814530,273648450,2341961529,1302903934,240},
{4229693441,518763675,1278012998,2937643583,760367970,4160480112,2518528172,2735385726,3897173548,2369603952,3651026482,240},
{4230021121,1223844765,3201731690,2646435602,2357988003,2325689511,3298812076,3165254438,2767069212,466595100,3969160071,240},
{4230807553,1719614369,1364111282,969229586,2494927938,276156212,3718045487,3728696165,3113203346,1443897795,438512344,241},
{4232052737,692469407,4124573297,2999968366,3214570001,3268931478,2169959938,494385525,2696406352,3906838371,1650996904,241},
{4232183809,3280451677,102940984,3193453532,3228494597,306304133,1041913148,1540366765,543080218,4146885378,1778792049,241}
};

uint32_t mod_reduce_crt_Q_constants[16][13] = {
{0,0,0,0,0,0,0,0,0,0,0,0,0},
{3294429183,1070036127,3409756667,1841750891,3364634320,2092234140,2913242245,1061346142,4195106495,4010670095,3908514152,997149517,4},
{2293891070,2140072255,2524546038,3683501783,2434301344,4184468281,1531517194,2122692285,4095245694,3726372895,3522061009,1994299035,8},
{1293352957,3210108383,1639335409,1230285379,1503968369,1981735126,149792144,3184038428,3995384893,3442075695,3135607866,2991448553,12},
{292814844,4280144511,754124780,3072036271,573635393,4073969267,3063034389,4245384570,3895524092,3157778495,2749154723,3988598071,16},
{3587244027,1055213342,4163881448,618819866,3938269714,1871236111,1681309339,1011763417,3795663292,2873481295,2362701580,690780293,21},
{2586705914,2125249470,3278670819,2460570758,3007936738,3963470252,299584288,2073109560,3695802491,2589184095,1976248437,1687929811,25},
{1586167801,3195285598,2393460190,7354354,2077603763,1760737097,3212826534,3134455702,3595941690,2304886895,1589795294,2685079329,29},
{585629688,4265321726,1508249561,1849105246,1147270787,3852971238,1831101483,4195801845,3496080889,2020589695,1203342151,3682228847,33},
{3880058871,1040390557,623038933,3690856138,216937811,1650238083,449376433,962180692,3396220089,1736292495,816889008,384411069,38},
{2879520758,2110426685,4032795600,1237639733,3581572132,3742472223,3362618678,2023526834,3296359288,1451995295,430435865,1381560587,42},
{1878982645,3180462813,3147584971,3079390625,2651239156,1539739068,1980893628,3084872977,3196498487,1167698095,43982722,2378710105,46},
{878444532,4250498941,2262374342,626174221,1720906181,3631973209,599168577,4146219120,3096637686,883400895,3952496875,3375859622,50},
{4172873715,1025567772,1377163714,2467925113,790573205,1429240054,3512410823,912597966,2996776886,599103695,3566043732,78041844,55},
{3172335602,2095603900,491953085,14708709,4155207526,3521474194,2130685772,1973944109,2896916085,314806495,3179590589,1075191362,59},
{1171259376,4235676156,3016499123,3698210492,2294541574,3410975180,3662202967,4096636394,2697194483,4041179391,2406684302,3069490398,3}
};

uint32_t Q[13] = {1000538113,3224931168,885210628,2453216404,930332975,2202733155,1381725050,3233621153,99860800,284297200,386453143,3297817778,59};
uint32_t Qby2[13] =
{500269056,1612465584,442605314,3374091850,2612650135,1101366577,2838346173,1616810576,49930400,2289632248,193226571,3796392537,29};

uint32_t q[6] = {2131034113,3715473008,29161862,3933102507,743308008,1032606};
uint32_t qby2[6] = {1065517056,1857736504,2162064579,1966551253,371654004,516303};

uint32_t two_pow608_x_33_by_q[14] =
{2698673986,
428327610,
2972893876,
4233020363,
2031023472,
1194838745,
2883557849,
3399937929,
3997887103,
1287996678,
2255014485,
2013879447,
1924386153,
137258};

uint32_t red_q0[64][6] ={
{0, 0, 0, 0, 0, 0},
{2163933183, 579494287, 4265805433, 361864788, 3551659287, 15969},
{32899070, 1158988575, 4236643570, 723729577, 2808351278, 31939},
{2196832253, 1738482862, 4207481707, 1085594366, 2065043269, 47909},
{65798140, 2317977150, 4178319844, 1447459155, 1321735260, 63879},
{2229731323, 2897471437, 4149157981, 1809323944, 578427251, 79849},
{98697210, 3476965725, 4119996118, 2171188733, 4130086538, 95818},
{2262630393, 4056460012, 4090834255, 2533053522, 3386778529, 111788},
{131596280, 340987004, 4061672393, 2894918311, 2643470520, 127758},
{2295529463, 920481291, 4032510530, 3256783100, 1900162511, 143728},
{164495350, 1499975579, 4003348667, 3618647889, 1156854502, 159698},
{2328428533, 2079469866, 3974186804, 3980512678, 413546493, 175668},
{197394420, 2658964154, 3945024941, 47410171, 3965205781, 191637},
{2361327603, 3238458441, 3915863078, 409274960, 3221897772, 207607},
{230293490, 3817952729, 3886701215, 771139749, 2478589763, 223577},
{2394226673, 102479720, 3857539353, 1133004538, 1735281754, 239547},
{263192560, 681974008, 3828377490, 1494869327, 991973745, 255517},
{2427125743, 1261468295, 3799215627, 1856734116, 248665736, 271487},
{296091630, 1840962583, 3770053764, 2218598905, 3800325023, 287456},
{2460024813, 2420456870, 3740891901, 2580463694, 3057017014, 303426},
{328990700, 2999951158, 3711730038, 2942328483, 2313709005, 319396},
{2492923883, 3579445445, 3682568175, 3304193272, 1570400996, 335366},
{361889770, 4158939733, 3653406312, 3666058061, 827092987, 351336},
{2525822953, 443466724, 3624244450, 4027922850, 83784978, 367306},
{394788840, 1022961012, 3595082587, 94820343, 3635444266, 383275},
{2558722023, 1602455299, 3565920724, 456685132, 2892136257, 399245},
{427687910, 2181949587, 3536758861, 818549921, 2148828248, 415215},
{2591621093, 2761443874, 3507596998, 1180414710, 1405520239, 431185},
{460586980, 3340938162, 3478435135, 1542279499, 662212230, 447155},
{2624520163, 3920432449, 3449273272, 1904144288, 4213871517, 463124},
{493486050, 204959441, 3420111410, 2266009077, 3470563508, 479094},
{2657419233, 784453728, 3390949547, 2627873866, 2727255499, 495064},
{526385120, 1363948016, 3361787684, 2989738655, 1983947490, 511034},
{2690318303, 1943442303, 3332625821, 3351603444, 1240639481, 527004},
{559284190, 2522936591, 3303463958, 3713468233, 497331472, 542974},
{2723217373, 3102430878, 3274302095, 4075333022, 4048990759, 558943},
{592183260, 3681925166, 3245140232, 142230515, 3305682751, 574913},
{2756116443, 4261419453, 3215978369, 504095304, 2562374742, 590883},
{625082330, 545946445, 3186816507, 865960093, 1819066733, 606853},
{2789015513, 1125440732, 3157654644, 1227824882, 1075758724, 622823},
{657981400, 1704935020, 3128492781, 1589689671, 332450715, 638793},
{2821914583, 2284429307, 3099330918, 1951554460, 3884110002, 654762},
{690880470, 2863923595, 3070169055, 2313419249, 3140801993, 670732},
{2854813653, 3443417882, 3041007192, 2675284038, 2397493984, 686702},
{723779540, 4022912170, 3011845329, 3037148827, 1654185975, 702672},
{2887712723, 307439161, 2982683467, 3399013616, 910877966, 718642},
{756678610, 886933449, 2953521604, 3760878405, 167569957, 734612},
{2920611793, 1466427736, 2924359741, 4122743194, 3719229244, 750581},
{789577680, 2045922024, 2895197878, 189640687, 2975921236, 766551},
{2953510863, 2625416311, 2866036015, 551505476, 2232613227, 782521},
{822476750, 3204910599, 2836874152, 913370265, 1489305218, 798491},
{2986409933, 3784404886, 2807712289, 1275235054, 745997209, 814461},
{855375820, 68931878, 2778550427, 1637099843, 2689200, 830431},
{3019309003, 648426165, 2749388564, 1998964632, 3554348487, 846400},
{888274890, 1227920453, 2720226701, 2360829421, 2811040478, 862370},
{3052208073, 1807414740, 2691064838, 2722694210, 2067732469, 878340},
{921173960, 2386909028, 2661902975, 3084558999, 1324424460, 894310},
{3085107143, 2966403315, 2632741112, 3446423788, 581116451, 910280},
{954073030, 3545897603, 2603579249, 3808288577, 4132775738, 926249},
{3118006213, 4125391890, 2574417386, 4170153366, 3389467729, 942219},
{986972100, 409918882, 2545255524, 237050859, 2646159721, 958189},
{3150905283, 989413169, 2516093661, 598915648, 1902851712, 974159},
{1019871170, 1568907457, 2486931798, 960780437, 1159543703, 990129},
{3183804353, 2148401744, 2457769935, 1322645226, 416235694, 1006099}
};
uint32_t red_q1[64][6] ={
{0, 0, 0, 0, 0, 0},
{1052770240, 2727896032, 2428608072, 1684510015, 3967894981, 1022068},
{4269473663, 1740319055, 533086986, 3730884820, 2897514657, 1011531},
{3191209790, 752742079, 2932533196, 1482292328, 1827134334, 1000994},
{2112945917, 4060132399, 1037012109, 3528667133, 756754010, 990457},
{1034682044, 3072555423, 3436458319, 1280074641, 3981340983, 979919},
{4251385467, 2084978446, 1540937233, 3326449446, 2910960659, 969382},
{3173121594, 1097401470, 3940383443, 1077856954, 1840580336, 958845},
{2094857721, 109824494, 2044862357, 3124231759, 770200012, 948308},
{1016593848, 3417214814, 149341270, 875639268, 3994786985, 937770},
{4233297271, 2429637837, 2548787480, 2922014072, 2924406661, 927233},
{3155033398, 1442060861, 653266394, 673421581, 1854026338, 916696},
{2076769525, 454483885, 3052712604, 2719796385, 783646014, 906159},
{998505652, 3761874205, 1157191517, 471203894, 4008232987, 895621},
{4215209075, 2774297228, 3556637727, 2517578698, 2937852663, 885084},
{3136945202, 1786720252, 1661116641, 268986207, 1867472340, 874547},
{2058681329, 799143276, 4060562851, 2315361011, 797092016, 864010},
{980417456, 4106533596, 2165041764, 66768520, 4021678989, 853472},
{4197120879, 3118956619, 269520678, 2113143325, 2951298665, 842935},
{3118857006, 2131379643, 2668966888, 4159518129, 1880918341, 832398},
{2040593133, 1143802667, 773445802, 1910925638, 810538018, 821861},
{962329260, 156225691, 3172892012, 3957300442, 4035124990, 811323},
{4179032683, 3463616010, 1277370925, 1708707951, 2964744667, 800786},
{3100768810, 2476039034, 3676817135, 3755082755, 1894364343, 790249},
{2022504937, 1488462058, 1781296049, 1506490264, 823984020, 779712},
{944241064, 500885082, 4180742259, 3552865068, 4048570992, 769174},
{4160944487, 3808275401, 2285221172, 1304272577, 2978190669, 758637},
{3082680614, 2820698425, 389700086, 3350647382, 1907810345, 748100},
{2004416741, 1833121449, 2789146296, 1102054890, 837430022, 737563},
{926152868, 845544473, 893625210, 3148429695, 4062016994, 727025},
{4142856291, 4152934792, 3293071419, 899837203, 2991636671, 716488},
{3064592418, 3165357816, 1397550333, 2946212008, 1921256347, 705951},
{1986328545, 2177780840, 3796996543, 697619516, 850876024, 695414},
{908064672, 1190203864, 1901475457, 2743994321, 4075462996, 684876},
{4124768095, 202626887, 5954371, 495401830, 3005082673, 674339},
{3046504222, 3510017207, 2405400580, 2541776634, 1934702349, 663802},
{1968240349, 2522440231, 509879494, 293184143, 864322026, 653265},
{889976476, 1534863255, 2909325704, 2339558947, 4088908998, 642727},
{4106679899, 547286278, 1013804618, 90966456, 3018528675, 632190},
{3028416026, 3854676598, 3413250827, 2137341260, 1948148351, 621653},
{1950152153, 2867099622, 1517729741, 4183716065, 877768027, 611116},
{871888280, 1879522646, 3917175951, 1935123573, 4102355000, 600578},
{4088591703, 891945669, 2021654865, 3981498378, 3031974676, 590041},
{3010327830, 4199335989, 126133778, 1732905887, 1961594353, 579504},
{1932063957, 3211759013, 2525579988, 3779280691, 891214029, 568967},
{853800084, 2224182037, 630058902, 1530688200, 4115801002, 558429},
{4070503507, 1236605060, 3029505112, 3577063004, 3045420678, 547892},
{2992239634, 249028084, 1133984026, 1328470513, 1975040355, 537355},
{1913975761, 3556418404, 3533430235, 3374845317, 904660031, 526818},
{835711888, 2568841428, 1637909149, 1126252826, 4129247004, 516280},
{4052415311, 1581264451, 4037355359, 3172627630, 3058866680, 505743},
{2974151438, 593687475, 2141834273, 924035139, 1988486357, 495206},
{1895887565, 3901077795, 246313186, 2970409944, 918106033, 484669},
{817623692, 2913500819, 2645759396, 721817452, 4142693006, 474131},
{4034327115, 1925923842, 750238310, 2768192257, 3072312682, 463594},
{2956063242, 938346866, 3149684520, 519599765, 2001932359, 453057},
{1877799369, 4245737186, 1254163433, 2565974570, 931552035, 442520},
{799535496, 3258160210, 3653609643, 317382078, 4156139008, 431982},
{4016238919, 2270583233, 1758088557, 2363756883, 3085758684, 421445},
{2937975046, 1283006257, 4157534767, 115164391, 2015378361, 410908},
{1859711173, 295429281, 2262013681, 2161539196, 944998037, 400371},
{781447300, 3602819601, 366492594, 4207914001, 4169585009, 389833},
{3998150723, 2615242624, 2765938804, 1959321509, 3099204686, 379296},
{2919886850, 1627665648, 870417718, 4005696314, 2028824362, 368759}
};

uint32_t red_q2[64][6] = {
{0, 0, 0, 0, 0, 0},
{1841622977, 640088672, 3269863928, 1757103822, 958444039, 358222},
{3683245954, 1280177344, 2244760560, 3514207645, 1916888078, 716444},
{3393834818, 2499760304, 1190495329, 1338208961, 2132024109, 42060},
{940490499, 3139848977, 165391961, 3095312784, 3090468148, 400282},
{2782113476, 3779937649, 3435255889, 557449310, 4048912188, 758504},
{2492702340, 704553313, 2380990659, 2676417922, 4264048218, 84120},
{39358021, 1344641986, 1355887291, 138554449, 927524962, 442343},
{1880980998, 1984730658, 330783923, 1895658272, 1885969001, 800565},
{1591569862, 3204313618, 3571485988, 4014626883, 2101105031, 126181},
{3433192839, 3844402290, 2546382620, 1476763410, 3059549071, 484403},
{979848520, 189523667, 1521279253, 3233867233, 4017993110, 842625},
{690437384, 1409106627, 467014022, 1057868549, 4233129141, 168241},
{2532060361, 2049195299, 3736877950, 2814972371, 896605884, 526464},
{78716042, 2689283972, 2711774582, 277108898, 1855049924, 884686},
{4084272202, 3908866931, 1657509351, 2396077510, 2070185954, 210302},
{1630927883, 253988308, 632405984, 4153181333, 3028629993, 568524},
{3472550860, 894076980, 3902269912, 1615317859, 3987074033, 926746},
{3183139724, 2113659940, 2848004681, 3734286471, 4202210063, 252362},
{729795405, 2753748613, 1822901313, 1196422998, 865686807, 610585},
{2571418382, 3393837285, 797797945, 2953526821, 1824130846, 968807},
{2282007246, 318452949, 4038500011, 777528136, 2039266877, 294423},
{4123630223, 958541621, 3013396643, 2534631959, 2997710916, 652645},
{1670285904, 1598630294, 1988293275, 4291735782, 3956154955, 1010867},
{1380874768, 2818213254, 934028044, 2115737098, 4171290986, 336483},
{3222497745, 3458301926, 4203891972, 3872840920, 834767729, 694706},
{2933086609, 382917590, 3149626742, 1696842236, 1049903760, 20322},
{479742290, 1023006263, 2124523374, 3453946059, 2008347799, 378544},
{2321365267, 1663094935, 1099420006, 916082586, 2966791839, 736766},
{2031954131, 2882677895, 45154775, 3035051198, 3181927869, 62382},
{3873577108, 3522766567, 3315018703, 497187724, 4140371909, 420604},
{1420232789, 4162855240, 2289915335, 2254291547, 803848652, 778827},
{1130821653, 1087470904, 1235650105, 78292863, 1018984683, 104443},
{2972444630, 1727559576, 210546737, 1835396686, 1977428722, 462665},
{519100311, 2367648249, 3480410665, 3592500508, 2935872761, 820887},
{229689175, 3587231209, 2426145434, 1416501824, 3151008792, 146503},
{2071312152, 4227319881, 1401042066, 3173605647, 4109452831, 504725},
{3912935129, 572441257, 375938699, 635742174, 772929575, 862948},
{3623523993, 1792024217, 3616640764, 2754710785, 988065605, 188564},
{1170179674, 2432112890, 2591537396, 216847312, 1946509645, 546786},
{3011802651, 3072201562, 1566434028, 1973951135, 2904953684, 905008},
{2722391515, 4291784522, 512168797, 4092919747, 3120089714, 230624},
{269047196, 636905899, 3782032726, 1555056273, 4078533754, 588846},
{2110670173, 1276994571, 2756929358, 3312160096, 742010497, 947069},
{1821259037, 2496577531, 1702664127, 1136161412, 957146528, 272685},
{3662882014, 3136666203, 677560759, 2893265235, 1915590567, 630907},
{1209537695, 3776754876, 3947424687, 355401761, 2874034607, 989129},
{920126559, 701370540, 2893159457, 2474370373, 3089170637, 314745},
{2761749536, 1341459212, 1868056089, 4231474196, 4047614676, 672967},
{308405217, 1981547885, 842952721, 1693610723, 711091420, 1031190},
{18994081, 3201130845, 4083654786, 3812579334, 926227450, 356806},
{1860617058, 3841219517, 3058551418, 1274715861, 1884671490, 715028},
{1571205922, 765835181, 2004286188, 3393684473, 2099807520, 40644},
{3412828899, 1405923853, 979182820, 855821000, 3058251560, 398866},
{959484580, 2046012526, 4249046748, 2612924822, 4016695599, 757088},
{670073444, 3265595486, 3194781517, 436926138, 4231831630, 82704},
{2511696421, 3905684158, 2169678149, 2194029961, 895308373, 440927},
{58352102, 250805535, 1144574782, 3951133784, 1853752412, 799149},
{4063908262, 1470388494, 90309551, 1775135100, 2068888443, 124765},
{1610563943, 2110477167, 3360173479, 3532238922, 3027332482, 482987},
{3452186920, 2750565839, 2335070111, 994375449, 3985776522, 841209},
{3162775784, 3970148799, 1280804880, 3113344061, 4200912552, 166825},
{709431465, 315270176, 255701513, 575480588, 864389296, 525048},
{2551054442, 955358848, 3525565441, 2332584410, 1822833335, 883270}
};

uint32_t red_q3[64][6] = {
{0, 0, 0, 0, 0, 0},
{2261643306, 2174941808, 2471300210, 156585726, 2037969366, 208886},
{228319316, 54916321, 647633125, 313171453, 4075938732, 417772},
{2489962622, 2229858129, 3118933335, 469757179, 1818940802, 626659},
{456638632, 109832642, 1295266250, 626342906, 3856910168, 835545},
{587247825, 2864268738, 3737404597, 1144793421, 856604229, 11826},
{2848891131, 744243250, 1913737512, 1301379148, 2894573595, 220712},
{815567141, 2919185059, 90070426, 1457964875, 637575665, 429599},
{3077210447, 799159571, 2561370637, 1614550601, 2675545031, 638485},
{1043886457, 2974101380, 737703551, 1771136328, 418547101, 847372},
{1174495650, 1433570180, 3179841899, 2289586843, 1713208458, 23652},
{3436138956, 3608511988, 1356174813, 2446172570, 3751177824, 232538},
{1402814966, 1488486501, 3827475024, 2602758296, 1494179894, 441425},
{3664458272, 3663428309, 2003807938, 2759344023, 3532149260, 650311},
{1631134282, 1543402822, 180140853, 2915929750, 1275151330, 859198},
{1761743475, 2871622, 2622279201, 3434380265, 2569812687, 35478},
{4023386781, 2177813430, 798612115, 3590965992, 312814757, 244365},
{1990062791, 57787943, 3269912326, 3747551718, 2350784123, 453251},
{4251706097, 2232729751, 1446245240, 3904137445, 93786193, 662138},
{2218382107, 112704264, 3917545451, 4060723171, 2131755559, 871024},
{2348991300, 2867140360, 2064716502, 284206391, 3426416917, 47304},
{315667310, 747114873, 241049417, 440792118, 1169418987, 256191},
{2577310616, 2922056681, 2712349627, 597377844, 3207388353, 465077},
{543986626, 802031194, 888682542, 753963571, 950390423, 673964},
{2805629932, 2976973002, 3359982752, 910549297, 2988359789, 882850},
{2936239125, 1436441802, 1507153804, 1428999813, 4283021146, 59130},
{902915135, 3611383611, 3978454014, 1585585539, 2026023216, 268017},
{3164558441, 1491358123, 2154786929, 1742171266, 4063992582, 476903},
{1131234451, 3666299932, 331119843, 1898756993, 1806994652, 685790},
{3392877757, 1546274444, 2802420054, 2055342719, 3844964018, 894676},
{3523486950, 5743244, 949591106, 2573793235, 844658079, 70957},
{1490162960, 2180685053, 3420891316, 2730378961, 2882627445, 279843},
{3751806266, 60659565, 1597224231, 2886964688, 625629515, 488730},
{1718482276, 2235601374, 4068524441, 3043550414, 2663598881, 697616},
{3980125582, 115575886, 2244857356, 3200136141, 406600951, 906503},
{4110734775, 2870011982, 392028407, 3718586657, 1701262308, 82783},
{2077410785, 749986495, 2863328618, 3875172383, 3739231674, 291669},
{44086795, 2924928304, 1039661532, 4031758110, 1482233744, 500556},
{2305730101, 804902816, 3510961743, 4188343836, 3520203110, 709442},
{272406111, 2979844625, 1687294657, 49962267, 1263205181, 918329},
{403015304, 1439313425, 4129433005, 568412782, 2557866538, 94609},
{2664658610, 3614255233, 2305765919, 724998509, 300868608, 303496},
{631334620, 1494229746, 482098834, 881584236, 2338837974, 512382},
{2892977926, 3669171554, 2953399044, 1038169962, 81840044, 721269},
{859653936, 1549146067, 1129731959, 1194755689, 2119809410, 930155},
{990263129, 8614867, 3571870307, 1713206204, 3414470767, 106435},
{3251906435, 2183556675, 1748203221, 1869791931, 1157472837, 315322},
{1218582445, 63531188, 4219503432, 2026377657, 3195442203, 524208},
{3480225751, 2238472996, 2395836346, 2182963384, 938444273, 733095},
{1446901761, 118447509, 572169261, 2339549111, 2976413639, 941981},
{1577510954, 2872883605, 3014307608, 2857999626, 4271074996, 118261},
{3839154260, 752858117, 1190640523, 3014585353, 2014077066, 327148},
{1805830270, 2927799926, 3661940733, 3171171079, 4052046432, 536034},
{4067473576, 807774438, 1838273648, 3327756806, 1795048502, 744921},
{2034149586, 2982716247, 14606562, 3484342533, 3833017868, 953807},
{2164758779, 1442185047, 2456744910, 4002793048, 832711929, 130088},
{131434789, 3617126856, 633077824, 4159378775, 2870681295, 338974},
{2393078095, 1497101368, 3104378035, 20997205, 613683366, 547861},
{359754105, 3672043177, 1280710949, 177582932, 2651652732, 756747},
{2621397411, 1552017689, 3752011160, 334168658, 394654802, 965634},
{2752006604, 11486489, 1899182212, 852619174, 1689316159, 141914},
{718682614, 2186428298, 75515126, 1009204901, 3727285525, 350800},
{2980325920, 66402810, 2546815337, 1165790627, 1470287595, 559687},
{947001930, 2241344619, 723148251, 1322376354, 3508256961, 768573}
};

uint32_t red_q4[64][6] = {
{0, 0, 0, 0, 0, 0},
{3208645236, 121319131, 3194448462, 1478962080, 1251259031, 977460},
{4286256359, 822132550, 2064767765, 3319788950, 1759210053, 922314},
{1068900186, 1522945970, 935087068, 865648524, 2267161076, 867168},
{2146511309, 2223759389, 4100373667, 2706475393, 2775112098, 812022},
{3224122432, 2924572808, 2970692970, 252334967, 3283063121, 756876},
{6766259, 3625386228, 1841012273, 2093161837, 3791014143, 701730},
{1084377382, 31232351, 711331577, 3933988707, 3997869, 646585},
{2161988505, 732045770, 3876618176, 1479848280, 511948892, 591439},
{3239599628, 1432859189, 2746937479, 3320675150, 1019899914, 536293},
{22243455, 2133672609, 1617256782, 866534724, 1527850937, 481147},
{1099854578, 2834486028, 487576085, 2707361594, 2035801959, 426001},
{2177465701, 3535299447, 3652862684, 253221167, 2543752982, 370855},
{3255076824, 4236112866, 2523181987, 2094048037, 3051704004, 315709},
{37720651, 641958990, 1393501291, 3934874907, 3559655026, 260563},
{1115331774, 1342772409, 263820594, 1480734481, 4067606049, 205417},
{2192942897, 2043585828, 3429107193, 3321561350, 280589775, 150272},
{3270554020, 2744399247, 2299426496, 867420924, 788540798, 95126},
{53197847, 3445212667, 1169745799, 2708247794, 1296491820, 39980},
{3261843083, 3566531798, 69226965, 4187209875, 2547750851, 1017440},
{44486910, 4267345218, 3234513564, 1733069448, 3055701874, 962294},
{1122098033, 673191341, 2104832868, 3573896318, 3563652896, 907148},
{2199709156, 1374004760, 975152171, 1119755892, 4071603919, 852002},
{3277320279, 2074818179, 4140438770, 2960582761, 284587645, 796857},
{59964106, 2775631599, 3010758073, 506442335, 792538668, 741711},
{1137575229, 3476445018, 1881077376, 2347269205, 1300489690, 686565},
{2215186352, 4177258437, 751396679, 4188096075, 1808440712, 631419},
{3292797475, 583104560, 3916683279, 1733955648, 2316391735, 576273},
{75441302, 1283917980, 2787002582, 3574782518, 2824342757, 521127},
{1153052425, 1984731399, 1657321885, 1120642092, 3332293780, 465981},
{2230663548, 2685544818, 527641188, 2961468962, 3840244802, 410835},
{3308274671, 3386358237, 3692927787, 507328535, 53228529, 355690},
{90918498, 4087171657, 2563247090, 2348155405, 561179551, 300544},
{1168529621, 493017780, 1433566394, 4188982275, 1069130573, 245398},
{2246140744, 1193831199, 303885697, 1734841849, 1577081596, 190252},
{3323751867, 1894644618, 3469172296, 3575668718, 2085032618, 135106},
{106395694, 2595458038, 2339491599, 1121528292, 2592983641, 79960},
{1184006817, 3296271457, 1209810902, 2962355162, 3100934663, 24814},
{97684757, 3417590589, 109292068, 146349947, 57226399, 1002275},
{1175295880, 4118404008, 3274578667, 1987176816, 565177421, 947129},
{2252907003, 524250131, 2144897971, 3828003686, 1073128443, 891983},
{3330518126, 1225063550, 1015217274, 1373863260, 1581079466, 836837},
{113161953, 1925876970, 4180503873, 3214690129, 2089030488, 781691},
{1190773076, 2626690389, 3050823176, 760549703, 2596981511, 726545},
{2268384199, 3327503808, 1921142479, 2601376573, 3104932533, 671399},
{3345995322, 4028317227, 791461782, 147236147, 3612883556, 616253},
{128639149, 434163351, 3956748382, 1988063016, 4120834578, 561107},
{1206250272, 1134976770, 2827067685, 3828889886, 333818304, 505962},
{2283861395, 1835790189, 1697386988, 1374749460, 841769327, 450816},
{3361472518, 2536603608, 567706291, 3215576330, 1349720349, 395670},
{144116345, 3237417028, 3732992890, 761435903, 1857671372, 340524},
{1221727468, 3938230447, 2603312193, 2602262773, 2365622394, 285378},
{2299338591, 344076570, 1473631497, 148122347, 2873573417, 230232},
{3376949714, 1044889989, 343950800, 1988949217, 3381524439, 175086},
{159593541, 1745703409, 3509237399, 3829776086, 3889475461, 119940},
{1237204664, 2446516828, 2379556702, 1375635660, 102459188, 64795},
{2314815787, 3147330247, 1249876005, 3216462530, 610410210, 9649},
{1228493727, 3268649379, 149357171, 400457315, 1861669242, 987109},
{2306104850, 3969462798, 3314643770, 2241284184, 2369620264, 931963},
{3383715973, 375308921, 2184963074, 4082111054, 2877571286, 876817},
{166359800, 1076122341, 1055282377, 1627970628, 3385522309, 821671},
{1243970923, 1776935760, 4220568976, 3468797497, 3893473331, 766525},
{2321582046, 2477749179, 3090888279, 1014657071, 106457058, 711380},
{3399193169, 3178562598, 1961207582, 2855483941, 614408080, 656234}
};

uint32_t red_q5[64][6] = {
{0, 0, 0, 0, 0, 0},
{181836996, 3879376018, 831526885, 401343515, 1122359103, 601088},
{2527607175, 4043279027, 1633891908, 1164551819, 1501410197, 169570},
{2709444171, 3627687749, 2465418794, 1565895334, 2623769300, 770658},
{760247054, 3791590759, 3267783817, 2329103638, 3002820394, 339140},
{942084050, 3375999481, 4099310703, 2730447153, 4125179497, 940228},
{3287854229, 3539902490, 606708430, 3493655458, 209263295, 508711},
{1338657112, 3703805500, 1409073453, 4256863762, 588314389, 77193},
{1520494108, 3288214222, 2240600339, 363239981, 1710673493, 678281},
{3866264287, 3452117231, 3042965362, 1126448285, 2089724587, 246763},
{4048101283, 3036525953, 3874492248, 1527791800, 3212083690, 847851},
{2098904166, 3200428963, 381889975, 2291000105, 3591134784, 416333},
{2280741162, 2784837685, 1213416861, 2692343620, 418526591, 1017422},
{331544045, 2948740695, 2015781884, 3455551924, 797577685, 585904},
{2677314224, 3112643704, 2818146907, 4218760228, 1176628779, 154386},
{2859151220, 2697052426, 3649673793, 325136447, 2298987883, 755474},
{909954103, 2860955436, 157071520, 1088344752, 2678038977, 323956},
{1091791099, 2445364158, 988598406, 1489688267, 3800398080, 925044},
{3437561278, 2609267167, 1790963429, 2252896571, 4179449174, 493526},
{1488364161, 2773170177, 2593328452, 3016104875, 263532972, 62009},
{1670201157, 2357578899, 3424855338, 3417448390, 1385892075, 663097},
{4015971336, 2521481908, 4227220361, 4180656694, 1764943169, 231579},
{4197808332, 2105890630, 763779951, 287032914, 2887302273, 832667},
{2248611215, 2269793640, 1566144974, 1050241218, 3266353367, 401149},
{2430448211, 1854202362, 2397671860, 1451584733, 93745174, 1002238},
{481251094, 2018105372, 3200036883, 2214793037, 472796268, 570720},
{2827021273, 2182008381, 4002401906, 2978001341, 851847362, 139202},
{3008858269, 1766417103, 538961496, 3379344857, 1974206465, 740290},
{1059661152, 1930320113, 1341326519, 4142553161, 2353257559, 308772},
{1241498148, 1514728835, 2172853405, 248929380, 3475616663, 909860},
{3587268327, 1678631844, 2975218428, 1012137684, 3854667757, 478342},
{1638071210, 1842534854, 3777583451, 1775345988, 4233718851, 46824},
{1819908206, 1426943576, 314143041, 2176689504, 1061110658, 647913},
{4165678385, 1590846585, 1116508064, 2939897808, 1440161752, 216395},
{52548085, 1175255308, 1948034950, 3341241323, 2562520855, 817483},
{2398318264, 1339158317, 2750399973, 4104449627, 2941571949, 385965},
{2580155260, 923567039, 3581926859, 210825846, 4063931053, 987053},
{630958143, 1087470049, 89324586, 974034151, 148014851, 555536},
{2976728322, 1251373058, 891689609, 1737242455, 527065945, 124018},
{3158565318, 835781780, 1723216495, 2138585970, 1649425048, 725106},
{1209368201, 999684790, 2525581518, 2901794274, 2028476142, 293588},
{1391205197, 584093512, 3357108404, 3303137789, 3150835245, 894676},
{3736975376, 747996521, 4159473427, 4066346093, 3529886339, 463158},
{1787778259, 911899531, 666871154, 534587102, 3908937434, 31640},
{1969615255, 496308253, 1498398040, 935930617, 736329241, 632729},
{20418138, 660211263, 2300763063, 1699138921, 1115380335, 201211},
{202255134, 244619985, 3132289949, 2100482436, 2237739438, 802299},
{2548025313, 408522994, 3934654972, 2863690740, 2616790532, 370781},
{2729862309, 4287899012, 471214561, 3265034256, 3739149635, 971869},
{780665192, 156834726, 1273579585, 4028242560, 4118200729, 540351},
{3126435371, 320737735, 2075944608, 496483568, 202284528, 108834},
{3308272367, 4200113753, 2907471493, 897827083, 1324643631, 709922},
{1359075250, 69049467, 3709836517, 1661035387, 1703694725, 278404},
{1540912246, 3948425485, 246396106, 2062378903, 2826053828, 879492},
{3886682425, 4112328494, 1048761129, 2825587207, 3205104922, 447974},
{1937485308, 4276231504, 1851126152, 3588795511, 3584156016, 16456},
{2119322304, 3860640226, 2682653038, 3990139026, 411547823, 617545},
{170125187, 4024543236, 3485018061, 458380034, 790598918, 186027},
{351962183, 3608951958, 21577651, 859723550, 1912958021, 787115},
{2697732362, 3772854967, 823942674, 1622931854, 2292009115, 355597},
{2879569358, 3357263689, 1655469560, 2024275369, 3414368218, 956685},
{930372241, 3521166699, 2457834583, 2787483673, 3793419312, 525167},
{3276142420, 3685069708, 3260199606, 3550691977, 4172470406, 93649},
{3457979416, 3269478430, 4091726492, 3952035492, 999862213, 694738}
};

int barrett60by30_red(uint64_t *a, uint32_t *b, int prime_index)
{
	uint64_t m_times_a_low, m_times_a_high;
	uint64_t a_low, a_high, quo;
	
	a_low = *a & 1073741823;
	a_high = (*a>>30);

	m_times_a_low = (uint64_t) a_low * barrett_constants[prime_index];
	m_times_a_high = (m_times_a_low>>30);
	m_times_a_low = m_times_a_low & 1073741823;

	m_times_a_high = m_times_a_high + (uint64_t) a_high*barrett_constants[prime_index];	
	
		
	quo = (m_times_a_high>>30);		

	*b = *a - quo*primes[prime_index];
	if(*b>primes[prime_index])
	*b = *b - primes[prime_index];

}


int scaling(uint32_t a_shares[], uint32_t scaled_shares[])
{
	int i;
	uint64_t temp;
	for(i=0; i<13; i++)
	{
		temp = (uint64_t) a_shares[i]*scaling_constants[i];
		barrett60by30_red(&temp, &scaled_shares[i], i);
	}
}

// Centerlift(mod Q)
int mod_reduce_crt_Q(uint32_t a[], uint32_t *sign)
{
	uint32_t a_extra;	// 4 bit extra than 390 bit Q
	uint8_t c_out, b_out;
	uint32_t diff_out[13];
	uint32_t i, j;	

	a_extra = a[12]>>6;	// 13th word has (394-12*32=10 bits)
	a[12] = a[12] & 63;
 	
	mp_add32(13, a, mod_reduce_crt_Q_constants[a_extra], 0, a, &c_out);
	
	/*
	printf("a_extra=%u\n", a_extra);
	for(i=0; i<13; i++)
	printf("%u\t", a[i]);
	printf("\n");
	*/

	b_out=0;
	do
	{
		mp_sub32(13, a, Q, 0, diff_out, &b_out);		
		if(b_out==0)
		{	
			for(i=0; i<13; i++)
			a[i] = diff_out[i];
		}
	}while(b_out==0);

	/*
	for(j=0; j<13; j++)
	printf("%u ", a[j]);
	printf("\n");
	*/

	*sign=0;
	mp_sub32(13, a, Qby2, 0, diff_out, &b_out);
	if(b_out==0)
	{	
		*sign=1;
		mp_sub32(13, Q, a, 0, a, &b_out);		
	}		
}

int mod_reduce_crt_rounded_val_q(uint32_t a[], uint8_t a_sign, uint32_t result[], uint8_t *result_sign)
{
	uint32_t a_extra;	// 4 bit extra than 390 bit Q
	uint8_t c_out, b_out;
	uint32_t diff_out[13];
	uint32_t i, j;	
	
	uint32_t acc[6];

	a_extra = a[5]>>20;	
	a_extra = a_extra & 63;
	for(i=0; i<6; i++)
	acc[i] = red_q0[a_extra][i];
	//printf("extra=%d\n", a_extra);

	//printf("Red_q-0\n"); 
	//for(i=0; i<6; i++)
	//printf("%u ", acc[i]);
	//printf("\n");

	a_extra = a[5]>>26;	
	a_extra = a_extra & 63;
	mp_add32(6, acc, red_q1[a_extra], 0, acc, &c_out);

	//printf("Red_q-1\n"); 
	//for(i=0; i<6; i++)
	//printf("%u ", acc[i]);
	//printf("\n");
	
	a_extra = a[6] & 63;
	mp_add32(6, acc, red_q2[a_extra], 0, acc, &c_out);
	//printf("Red_q-2\n"); 
	//for(i=0; i<6; i++)
	//printf("%u ", acc[i]);
	//printf("\n");


	a_extra = a[6]>>6;	
	a_extra = a_extra & 63;
	mp_add32(6, acc, red_q3[a_extra], 0, acc, &c_out);
	//printf("Red_q-3\n"); 
	//for(i=0; i<6; i++)
	//printf("%u ", acc[i]);
	//printf("\n");

	a_extra = a[6]>>12;	
	a_extra = a_extra & 63;
	mp_add32(6, acc, red_q4[a_extra], 0, acc, &c_out);
	//printf("Red_q-4\n"); 
	//for(i=0; i<6; i++)
	//printf("%u ", acc[i]);
	//printf("\n");

	a_extra = a[6]>>18;	
	a_extra = a_extra & 63;
	mp_add32(6, acc, red_q5[a_extra], 0, acc, &c_out);
	//printf("Red_q-5\n"); 
	//for(i=0; i<6; i++)
	//printf("%u ", acc[i]);
	//printf("\n");

	a[5] = a[5] & 1048575;	// a[5] has most sig 20 bits of 180 bit a
	a[6] = 0;
	mp_add32(6, acc, a, 0, result, &c_out); // a = a[179:0] + acc;

	b_out=0;
	do
	{
		mp_sub32(6, result, q, 0, diff_out, &b_out);		
		if(b_out==0)
		{	
			for(i=0; i<6; i++)
			result[i] = diff_out[i];
		}
	}while(b_out==0);

	*result_sign=a_sign;
	mp_sub32(6, result, qby2, 0, diff_out, &b_out);
	if(b_out==0)
	{	
		*result_sign=1-*result_sign;
		mp_sub32(6, q, result, 0, result, &b_out);		
	}		
}


int division_rounding_by_Q(uint32_t in_data[], uint32_t result[])
{
	int i, j;
	uint32_t division_result[13+14];
	uint32_t one[] = {1,0,0,0,0,0,0,0}; 

	// 33/q has 174 0s after decimal point.

	//printf("in data\n");
	//for(i=1; i<13; i++)
	//printf("%u ", in_data[i]);
	//printf("\n");
	
	//two_pow608_x_33_by_q[0]=0; two_pow608_x_33_by_q[1]=0; two_pow608_x_33_by_q[2]=0; two_pow608_x_33_by_q[3]=0; 
	//two_pow608_x_33_by_q[4]=0; two_pow608_x_33_by_q[5]=0; 
	//two_pow608_x_33_by_q[6]=0;

	mp_mul32(14, 13, two_pow608_x_33_by_q, in_data, division_result);
	
	// division by 2^608 (32*19=608)

	for(i=19; i<27; i++)
	result[i-19] = division_result[i];
	
	uint8_t c_out;
	if(division_result[18] >= 2147483648)	// check if >2^32
	{
		mp_add32(8, result, one, 0, result, &c_out);
	}		

	//printf("==\n");
	//for(i=0; i<8; i++)
	//printf("%u\n", result[i]);		
	//printf("\n==\n");
}

int crt_Q(uint32_t a_shares[], uint32_t result[], uint8_t sign_result)
{
	int i, j;
	uint32_t mul_out[1+12];
	uint32_t acc[1+12];
	uint8_t c_out;
	uint32_t scaled_a_shares[13];
	uint32_t sign;

	scaling(a_shares, scaled_a_shares);

	for(i=0; i<13; i++)
	acc[i]=0;

	for(i=0; i<13; i++)
	for(j=0; j<4; j++)
	crt_constant[i][j]=0;

	// acc contains CRT un-reduced Q
	for(i=0; i<13; i++)
	{
		mp_mul32_ui(12, crt_constant[i], scaled_a_shares[i], mul_out);
		mp_add32(13, mul_out, acc, 0, acc, &c_out);
	}


	mod_reduce_crt_Q(acc, &sign);

	//printf("Before division sign=%d\n", sign);
	//for(j=0; j<13; j++)
	//printf("%u ", acc[j]);
	//printf("\n");

	uint32_t rounding_result[8];
	division_rounding_by_Q(acc, rounding_result);
	//printf("Rounding Result\n");
	//for(j=0; j<8; j++)
	//printf("%u ", rounding_result[j]);
	//printf("\n");


	//uint32_t q_reduced_result[6];
	mod_reduce_crt_rounded_val_q(rounding_result, sign, result, &sign_result);	
	
}


/*
main()
{
	//uint64_t a=826049517794388541;
	//uint32_t b;
	//barrett60by30_red(&a, &b, 0);

	uint64_t repeat=10000000;
  	uint64_t CLOCK1,CLOCK2;
  	uint64_t CLOCK_comp=0;


	int i, j;

	uint32_t result[6];
	uint8_t sign_result;
	uint32_t a_shares[]={1,2,3,4,5,6,7,8,9,10,11,12,13};

  	for(i=0; i<repeat; i++)
  	{
		for(j=0; j<13; j++)
		a_shares[j] = rand();
		a_shares[j] = a_shares[j]&536870911;
 
	        //printf("i : %lu\n",i);
		CLOCK1=cpucycles();	
		crt_Q(a_shares, result, sign_result);
		CLOCK2=cpucycles();	
		CLOCK_comp=CLOCK_comp+(CLOCK2-CLOCK1);	
	}

	printf("Repeat is : %ld\n",repeat);
	printf("Average cycles division: \t %lu \n",CLOCK_comp/repeat);

	printf("Result sign = %u\n", sign_result);
	for(j=0; j<6; j++)
	printf("%u ", result[j]);
	printf("\n");
	
	unsigned char b_in, b_out; 
	unsigned int src1; 
	unsigned int src2; 
	unsigned int diff_out;
	
	//b_in = 1;
	//src1 = 5;
	//src2 = 5;
	//b_out = _subborrow_u32(b_in, src1, src2, &diff_out);
	//printf("bout = %u diff_out=%u\n", b_out, diff_out);
	
}
*/
